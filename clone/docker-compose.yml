services:
  db:
    restart: unless-stopped
    image: pgvector/pgvector:pg16
    env_file: .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-acobra}
      POSTGRES_USER: ${POSTGRES_USER:-acobra}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 15

  redis:
    restart: unless-stopped
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 15

  api:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      API_PORT: ${API_PORT:-8080}
      EMBEDDINGS_ENABLED: ${EMBEDDINGS_ENABLED:-0}
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      OLLAMA_CHAT_MODEL: ${OLLAMA_CHAT_MODEL:-}
      EMBED_DIM: ${EMBED_DIM:-768}
      EMBED_TIMEOUT_S: ${EMBED_TIMEOUT_S:-15}
      OLLAMA_TIMEOUT_S: ${OLLAMA_TIMEOUT_S:-30}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${API_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15

  worker:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      TRIAGE_QUEUE: ${TRIAGE_QUEUE:-q:triage}
      FETCH_QUEUE: ${FETCH_QUEUE:-q:fetch_parse}
      PARSE_QUEUE: ${PARSE_QUEUE:-q:parse}
      BOT_USERNAME: ${BOT_USERNAME:-}
      TELEGRAM_UF_CHANNELS: ${TELEGRAM_UF_CHANNELS:-}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["python", "-m", "app.worker_triage"]

  fetch_docs:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      FETCH_QUEUE: ${FETCH_QUEUE:-q:fetch_parse}
      PARSE_QUEUE: ${PARSE_QUEUE:-q:parse}
      DEAD_QUEUE: ${DEAD_QUEUE:-q:dead_fetch_docs}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["python", "-m", "app.worker_fetch_docs"]

  parse:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      PYTHONPATH: /app
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PARSE_QUEUE: ${PARSE_QUEUE:-q:parse}
      PARSE_OCR: ${PARSE_OCR:-0}
      OCR_MIN_TEXT: ${OCR_MIN_TEXT:-200}
      OCR_MAX_BYTES: ${OCR_MAX_BYTES:-20971520}
      OCR_TIMEOUT_S: ${OCR_TIMEOUT_S:-120}
      OCR_LANG: ${OCR_LANG:-por+eng}
      OCR_JOBS: ${OCR_JOBS:-2}
      OCR_DPI: ${OCR_DPI:-150}
      OCR_MAX_PAGES: ${OCR_MAX_PAGES:-12}
      OCR_PAGE_TIMEOUT_S: ${OCR_PAGE_TIMEOUT_S:-60}
      OCR_MODE: ${OCR_MODE:-pages}
      EMBEDDINGS_ENABLED: ${EMBEDDINGS_ENABLED:-0}
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      EMBED_DIM: ${EMBED_DIM:-768}
      EMBED_TIMEOUT_S: ${EMBED_TIMEOUT_S:-15}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["python", "-m", "app.worker_parse"]

  bot:
    restart: unless-stopped
    build: ./services/bot
    env_file: .env
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      API_BASE_URL: ${API_BASE_URL:-http://api:8080}
    depends_on:
      api:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["python", "-m", "bot.main"]

  pncp_fetch:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      CORE_API_URL: ${CORE_API_URL:-http://api:8080}
      CORE_API_KEY: ${CORE_API_KEY:-}
      PNCP_BASE_URL: ${PNCP_BASE_URL:-https://pncp.gov.br/api/consulta}
      PNCP_MODALIDADE_IDS: ${PNCP_MODALIDADE_IDS:-8}
      PNCP_PAGE_SIZE: ${PNCP_PAGE_SIZE:-50}
      PNCP_PAGE_SIZE_MIN: ${PNCP_PAGE_SIZE_MIN:-10}
      PNCP_MAX_PAGES: ${PNCP_MAX_PAGES:-20}
      PNCP_MAX_ITEMS: ${PNCP_MAX_ITEMS:-500}
      PNCP_SLEEP_S: ${PNCP_SLEEP_S:-1}
      PNCP_POLL_S: ${PNCP_POLL_S:-3600}
      PNCP_BACKOFF_S: ${PNCP_BACKOFF_S:-10}
      PNCP_DATA_INICIAL: ${PNCP_DATA_INICIAL:-}
      PNCP_DATA_FINAL: ${PNCP_DATA_FINAL:-}
      PNCP_UF: ${PNCP_UF:-}
      PNCP_CODIGO_MUNICIPIO_IBGE: ${PNCP_CODIGO_MUNICIPIO_IBGE:-}
      PNCP_CNPJ: ${PNCP_CNPJ:-}
      PNCP_CODIGO_UNIDADE_ADMINISTRATIVA: ${PNCP_CODIGO_UNIDADE_ADMINISTRATIVA:-}
      PNCP_CODIGO_MODO_DISPUTA: ${PNCP_CODIGO_MODO_DISPUTA:-}
      PNCP_ID_USUARIO: ${PNCP_ID_USUARIO:-}
    depends_on:
      api:
        condition: service_healthy
    command: ["python", "-m", "app.worker_pncp_fetch"]

  compras_fetch:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      CORE_API_URL: ${CORE_API_URL:-http://api:8080}
      CORE_API_KEY: ${CORE_API_KEY:-}
      COMPRAS_API_BASE: ${COMPRAS_API_BASE:-https://compras.dados.gov.br}
      COMPRAS_LIST_PATH: ${COMPRAS_LIST_PATH:-/licitacoes/v1/licitacoes.json}
      COMPRAS_DETAIL_PATH: ${COMPRAS_DETAIL_PATH:-/licitacoes/id/licitacao/{id}.json}
      COMPRAS_POLL_S: ${COMPRAS_POLL_S:-3600}
      COMPRAS_MAX_PAGES: ${COMPRAS_MAX_PAGES:-10}
      COMPRAS_MAX_ITEMS: ${COMPRAS_MAX_ITEMS:-500}
      COMPRAS_DATE_FIELD: ${COMPRAS_DATE_FIELD:-data_abertura_proposta}
      COMPRAS_DATA_INICIAL: ${COMPRAS_DATA_INICIAL:-}
      COMPRAS_DATA_FINAL: ${COMPRAS_DATA_FINAL:-}
      COMPRAS_UASG: ${COMPRAS_UASG:-}
      METRICS_ENABLED: ${METRICS_ENABLED:-1}
      METRICS_PREFIX: ${METRICS_PREFIX:-metrics:v1}
      METRICS_TTL_S: ${METRICS_TTL_S:-604800}
    depends_on:
      api:
        condition: service_healthy
    command: ["python", "-m", "app.worker_compras_fetch"]

  daily:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DAILY_POLL_S: ${DAILY_POLL_S:-3600}
      DAILY_LOOKBACK_H: ${DAILY_LOOKBACK_H:-24}
      DAILY_MAX_ITEMS: ${DAILY_MAX_ITEMS:-8}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
    depends_on:
      db:
        condition: service_healthy
    command: ["python", "-m", "app.worker_daily"]

  alerts:
    restart: unless-stopped
    build: ./services/api
    env_file: .env
    environment:
      REDIS_URL: ${REDIS_URL}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
      METRICS_PREFIX: ${METRICS_PREFIX:-metrics:v1}
      ALERTS_ENABLED: ${ALERTS_ENABLED:-1}
      ALERTS_POLL_S: ${ALERTS_POLL_S:-60}
      ALERTS_COOLDOWN_S: ${ALERTS_COOLDOWN_S:-300}
      ALERTS_QUEUE_THRESHOLDS: ${ALERTS_QUEUE_THRESHOLDS:-q:triage=500,q:fetch_parse=200,q:parse=200,q:dead_triage=1,q:dead_fetch_docs=1,q:dead_parse=1}
      ALERTS_COUNTER_THRESHOLDS: ${ALERTS_COUNTER_THRESHOLDS:-api.errors_5xx_total=5,worker.triage.dead_total=1,worker.fetch_docs.dead_total=1,worker.parse.dead_total=1}
      ALERTS_TELEGRAM_BOT_TOKEN: ${ALERTS_TELEGRAM_BOT_TOKEN:-}
      ALERTS_TELEGRAM_CHAT_ID: ${ALERTS_TELEGRAM_CHAT_ID:-}
    depends_on:
      redis:
        condition: service_healthy
    command: ["python", "-m", "app.worker_alerts"]

  ollama:
    profiles: ["llm"]
    image: ollama/ollama:latest
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama

volumes:
  pgdata:
  ollama:
